<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>SVA | Validaci칩n UBL</title>
    <meta name="description" content="Sistema de Validaci칩n y Auditor칤a para la detecci칩n de anomal칤as matem치ticas en archivos XML UBL.">
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      body {
        background-color: #f0f2f5;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      .card {
        border: none;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }
      .icon-box {
        width: 50px;
        height: 50px;
        flex-shrink: 0; /* Evita que el icono se aplaste en pantallas muy peque침as */
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
      }
      .xml-preview-box {
        max-height: 250px;
        overflow-y: auto;
        font-size: 0.8rem;
        background: #2d2d2d;
        color: #5ce1e6;
      }
      /* Ajuste para que las tablas no rompan el layout en m칩vil */
      .table-nowrap th, .table-nowrap td {
        white-space: nowrap;
      }
    </style>
  </head>
  <body class="pb-5">
    <div class="container py-4">

        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4 gap-3 text-center text-md-start">
            <div>
                <h3 class="fw-bold text-dark mb-0">
                    <i class="fas fa-laptop-code text-primary me-2"></i>SVA: Auditor칤a
                </h3>
                <small class="text-muted">Detecci칩n de anomal칤as en facturaci칩n UBL</small>
            </div>
            
            <button class="btn btn-primary w-100 w-md-auto" data-bs-toggle="modal" data-bs-target="#uploadModal">
                <i class="fas fa-plus me-2"></i>Nueva Auditor칤a
            </button>
        </div>

      <div class="row g-3 mb-4">
        <div class="col-12 col-sm-6 col-xl-3">
          <div class="card h-100">
            <div class="card-body d-flex align-items-center">
              <div class="icon-box bg-primary bg-opacity-10 text-primary me-3">
                <i class="fas fa-file-invoice fa-lg"></i>
              </div>
              <div>
                <h6 class="text-muted mb-0 small text-uppercase">
                  Docs Procesados
                </h6>
                <h4 class="fw-bold mb-0">{{ kpi_total }}</h4>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
          <div class="card h-100">
            <div class="card-body d-flex align-items-center">
              <div class="icon-box bg-success bg-opacity-10 text-success me-3">
                <i class="fas fa-dollar-sign fa-lg"></i>
              </div>
              <div>
                <h6 class="text-muted mb-0 small text-uppercase">
                  Monto Auditado
                </h6>
                <h4 class="fw-bold mb-0">S/ {{ kpi_money }}</h4>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
          <div class="card h-100">
            <div class="card-body d-flex align-items-center">
              <div class="icon-box bg-info bg-opacity-10 text-info me-3">
                <i class="fas fa-check-double fa-lg"></i>
              </div>
              <div>
                <h6 class="text-muted mb-0 small text-uppercase">
                  Cumplimiento
                </h6>
                <h4 class="fw-bold mb-0">
                  {{ kpi_valid }} <small class="text-muted fs-6">Docs</small>
                </h4>
              </div>
            </div>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-xl-3">
          <div class="card h-100">
            <div class="card-body d-flex align-items-center">
              <div class="icon-box bg-danger bg-opacity-10 text-danger me-3">
                <i class="fas fa-exclamation-triangle fa-lg"></i>
              </div>
              <div>
                <h6 class="text-muted mb-0 small text-uppercase">
                  Discrepancias
                </h6>
                <h4 class="fw-bold mb-0">
                  {{ kpi_error }} <small class="text-muted fs-6">Docs</small>
                </h4>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3 mb-4">
        <div class="col-lg-8">
          <div class="card h-100 p-3">
            <h6 class="fw-bold text-muted mb-3">
              游늳 Volumen (칔ltimos D칤as)
            </h6>
            <div style="height: 300px; position: relative; width: 100%;">
              <canvas id="trendChart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="card h-100 p-3">
            <h6 class="fw-bold text-muted mb-3">游꿢 Tasa de Validaci칩n</h6>
            <div style="height: 250px; display: flex; justify-content: center; position: relative;">
              <canvas id="statusChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      {% if messages %} {% for message in messages %}
      <div
        class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm"
        role="alert"
      >
        {{ message }}
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="alert"
        ></button>
      </div>
      {% endfor %} {% endif %}

      <div class="card">
        <div class="card-header bg-white py-3">
          <h6 class="mb-0 fw-bold">Historial de Auditor칤a</h6>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle mb-0 table-nowrap">
            <thead class="table-light small text-uppercase">
              <tr>
                <th class="ps-4">Fecha Carga</th>
                <th>ID Factura</th>
                <th>Monto Rep.</th>
                <th>Monto Calc.</th>
                <th>Estado</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for inv in invoices %}
              <tr>
                <td class="ps-4 text-muted small">
                  {{ inv.upload_date|date:"d/m/Y H:i" }}
                </td>
                <td class="fw-bold text-dark">{{ inv.invoice_id }}</td>
                <td><small>{{ inv.currency }}</small> {{ inv.total_reported }}</td>
                <td><small>{{ inv.currency }}</small> {{ inv.total_calculated }}</td>
                <td>
                  {% if inv.is_mathematically_valid %}
                  <span
                    class="badge bg-success-subtle text-success border border-success px-2"
                    >Aprobado</span
                  >
                  {% else %}
                  <span
                    class="badge bg-danger-subtle text-danger border border-danger px-2"
                    >Error</span
                  >
                  {% endif %}
                </td>
                <td>
                  <button
                    class="btn btn-sm btn-outline-primary"
                    onclick="showDbDetail(Number('{{ inv.pk }}'))"
                  >
                    <i class="fas fa-eye"></i>
                  </button>
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="6" class="text-center py-4">
                  Sin datos disponibles
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="modal fade" id="uploadModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Cargar Nuevos XMLs</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <ul class="nav nav-tabs mb-3 nav-fill" id="myTab" role="tablist"> <li class="nav-item">
                <button
                  class="nav-link active"
                  data-bs-toggle="tab"
                  data-bs-target="#pc-tab"
                >
                  Subir Archivo
                </button>
              </li>
              <li class="nav-item">
                <button
                  class="nav-link"
                  data-bs-toggle="tab"
                  data-bs-target="#repo-tab"
                >
                  Usar Repositorio
                </button>
              </li>
            </ul>
            <div class="tab-content">
              <div class="tab-pane fade show active" id="pc-tab">
                <form
                  action="{% url 'upload' %}"
                  method="POST"
                  enctype="multipart/form-data"
                  class="text-center p-3 p-md-4 bg-light rounded border border-dashed"
                >
                  {% csrf_token %}
                  <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                  <p class="text-muted mb-2">
                    Selecciona XMLs
                  </p>

                  <input
                    type="file"
                    class="form-control mb-3"
                    name="xml_file"
                    accept=".xml"
                    multiple
                    required
                  />

                  <button class="btn btn-primary w-100">
                    <i class="fas fa-bolt me-2"></i>Procesar Lote
                  </button>
                </form>
              </div>

              <div class="tab-pane fade" id="repo-tab">
                <form action="{% url 'upload' %}" method="POST">
                  {% csrf_token %}

                  <button
                    type="submit"
                    name="process_all"
                    value="true"
                    class="btn btn-primary w-100 mb-3"
                  >
                    <i class="fas fa-layer-group me-2"></i>Procesar Todo
                  </button>

                  <hr class="text-muted my-3" />
                  <p class="small text-muted mb-2">
                    O selecciona individual:
                  </p>

                  <div class="input-group mb-3 d-flex flex-column flex-sm-row"> <select
                      class="form-select w-100 mb-2 mb-sm-0 rounded"
                      name="sample_filename"
                      id="sampleSelector"
                    >
                      <option value="" disabled selected>
                        Selecciona un ejemplo...
                      </option>
                      {% for sample in available_samples %}
                      <option value="{{ sample }}">{{ sample }}</option>
                      {% endfor %}
                    </select>
                    <button
                      class="btn btn-outline-secondary w-100 w-sm-auto rounded"
                      type="button"
                      id="btnPreview"
                    >
                      <i class="far fa-eye"></i> Ver
                    </button>
                  </div>

                  <div
                    id="invoicePreviewCard"
                    class="card shadow-sm mb-3 border-0"
                    style="display: none; background: #fffdf8"
                  >
                    <div
                      class="card-body p-3 border border-secondary border-opacity-25 rounded"
                    >
                      <div
                        class="d-flex justify-content-between border-bottom pb-2 mb-2"
                      >
                        <div class="text-truncate me-2">
                          <small class="text-muted d-block"
                            >FACTURA ELECTR칍NICA</small
                          >
                          <strong class="text-dark" id="prevId">---</strong>
                        </div>
                        <div class="text-end">
                          <small class="text-muted d-block">FECHA</small>
                          <span id="prevDate" class="small">---</span>
                        </div>
                      </div>

                      <div class="table-responsive">
                          <table class="table table-sm table-borderless small mb-2">
                            <thead class="text-muted border-bottom">
                              <tr>
                                <th>Desc</th>
                                <th class="text-end">P.U.</th>
                                <th class="text-end">Cant.</th>
                                <th class="text-end">Total</th>
                              </tr>
                            </thead>
                            <tbody id="prevItems"></tbody>
                          </table>
                      </div>

                      <div class="border-top pt-2 mt-2">
                        <div class="d-flex justify-content-between mb-1">
                          <span class="text-muted small">Suma (Real):</span>
                          <span class="fw-bold text-muted" id="prevCalc">---</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                          <span class="fw-bold text-dark small">Total XML:</span>
                          <span class="fw-bold fs-5" id="prevRep">---</span>
                        </div>
                      </div>
                    </div>
                  </div>

                  <button
                    type="submit"
                    class="btn btn-success w-100"
                    id="btnProcessSample"
                    disabled
                  >
                    Procesar Esta
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="modal fade" id="detailModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Detalle de Factura</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <div class="card shadow-sm border-0" style="background: #fffdf8">
              <div
                class="card-body p-3 border border-secondary border-opacity-25 rounded"
              >
                <div
                  class="d-flex justify-content-between border-bottom pb-2 mb-2"
                >
                  <div class="text-truncate me-2"><strong class="text-dark" id="dbId">---</strong></div>
                  <div class="text-end">
                    <small class="text-muted" id="dbDate">---</small>
                  </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-sm table-borderless small mb-2">
                    <thead class="text-muted border-bottom">
                        <tr>
                        <th>Desc</th>
                        <th class="text-end">P.Unit</th>
                        <th class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody id="dbItems"></tbody>
                    </table>
                </div>
                <div class="border-top pt-2 mt-2">
                  <div class="d-flex justify-content-between mb-1">
                    <span class="text-muted small">Suma (Calc):</span>
                    <span class="fw-bold text-muted" id="dbCalc">---</span>
                  </div>
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="fw-bold text-dark small">Total Rep:</span>
                    <span class="fw-bold fs-5" id="dbRep">---</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      // 1. Gr치fico de Estado (Dona)
      const ctxStatus = document.getElementById('statusChart').getContext('2d')
      new Chart(ctxStatus, {
        type: 'doughnut',
        data: {
          labels: ['V치lidos', 'Errores'],
          datasets: [
            {
              data: [
                Number('{{ kpi_valid|default:0 }}'),
                Number('{{ kpi_error|default:0 }}'),
              ],
              backgroundColor: ['#198754', '#dc3545'],
              borderWidth: 0,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          cutout: '70%',
        },
      })

      // 2. Gr치fico de Tendencia
      const trendLabels = JSON.parse('{{ chart_labels|safe }}')
      const trendData = JSON.parse('{{ chart_data|safe }}')

      const ctxTrend = document.getElementById('trendChart').getContext('2d')
      new Chart(ctxTrend, {
        type: 'line',
        data: {
          labels: trendLabels,
          datasets: [
            {
              label: 'Monto Total (PEN)',
              data: trendData,
              borderColor: '#0d6efd',
              backgroundColor: 'rgba(13, 110, 253, 0.1)',
              fill: true,
              tension: 0.4,
              pointRadius: 4,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: { beginAtZero: true, grid: { borderDash: [2, 4] } },
            x: { grid: { display: false } },
          },
        },
      })

      // --- L칍GICA DE PREVIEW VISUAL ---
      const selector = document.getElementById('sampleSelector')
      const previewBtn = document.getElementById('btnPreview')
      const previewCard = document.getElementById('invoicePreviewCard')
      const processBtn = document.getElementById('btnProcessSample')

      const uiId = document.getElementById('prevId')
      const uiDate = document.getElementById('prevDate')
      const uiCalc = document.getElementById('prevCalc')
      const uiRep = document.getElementById('prevRep')
      const uiItems = document.getElementById('prevItems')

      selector.addEventListener(
        'change',
        () => (processBtn.disabled = !selector.value)
      )

      previewBtn.addEventListener('click', () => {
        const filename = selector.value
        if (!filename) return

        uiItems.innerHTML =
          '<tr><td colspan="3" class="text-center">Cargando...</td></tr>'
        previewCard.style.display = 'block'

        fetch(`/preview-sample/?filename=${encodeURIComponent(filename)}`)
          .then((r) => r.json())
          .then((data) => {
            if (data.error) {
              uiItems.innerHTML = `<tr><td colspan="3" class="text-danger">${data.error}</td></tr>`
              return
            }

            uiId.textContent = data.id;
            uiDate.textContent = data.date;
            
            const tCalc = parseFloat(data.total_calculated);
            const tRep = parseFloat(data.total_reported);
            uiCalc.textContent = 'S/ ' + tCalc.toFixed(2);
            uiRep.textContent = 'S/ ' + tRep.toFixed(2);
            if (Math.abs(tCalc - tRep) > 0.01) {
              uiRep.className = "fw-bold fs-5 text-danger";
              uiRep.innerHTML += ' <i class="fas fa-exclamation-circle small"></i>';
            } else {
              uiRep.className = "fw-bold fs-5 text-success";
            }
            
            let rows = '';
            data.items.forEach((item) => {
              const subtotal = parseFloat(item.subtotal).toFixed(2);
              const unitPrice = parseFloat(item.price).toFixed(2);
              // Texto truncado en descripci칩n para m칩vil
              rows += `
            <tr>
                <td class="text-truncate" style="max-width: 120px;" title="${item.desc}">${item.desc}</td>
                <td class="text-end text-muted">${unitPrice}</td> 
                <td class="text-end text-muted">x${parseInt(item.qty)}</td>
                <td class="text-end fw-bold">${subtotal}</td>
            </tr>
        `;
            });
            uiItems.innerHTML = rows;
          })
          .catch((err) => {
            console.error(err)
            uiItems.innerHTML =
              '<tr><td colspan="3" class="text-danger">Error de conexi칩n</td></tr>'
          })
      })

      function showDbDetail(pk) {
        const modalEl = document.getElementById('detailModal');
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

        document.getElementById('dbItems').innerHTML = '<tr><td colspan="3" class="text-center py-3">Cargando datos...</td></tr>';
        document.getElementById('dbId').textContent = '...';
        document.getElementById('dbDate').textContent = '...';
        document.getElementById('dbCalc').textContent = '...';
        document.getElementById('dbRep').textContent = '...';

        modal.show();

        fetch(`/api/invoice/${pk}/`)
          .then(r => {
            if (!r.ok) throw new Error("Error en servidor");
            return r.json();
          })
          .then(data => {
            if (data.error) {
              document.getElementById('dbItems').innerHTML = `<tr><td colspan="3" class="text-danger text-center">${data.error}</td></tr>`;
              return;
            }
            document.getElementById('dbId').textContent = data.id;
            document.getElementById('dbDate').textContent = data.date;
            
            const tCalc = parseFloat(data.total_calculated);
            const tRep = parseFloat(data.total_reported);
            document.getElementById('dbCalc').textContent = 'S/ ' + tCalc.toFixed(2);
            const repEl = document.getElementById('dbRep');
            repEl.textContent = 'S/ ' + tRep.toFixed(2);
            if (Math.abs(tCalc - tRep) > 0.01) {
              repEl.className = "fw-bold fs-5 text-danger";
              repEl.innerHTML += ' <i class="fas fa-exclamation-circle small"></i>';
            } else {
              repEl.className = "fw-bold fs-5 text-success";
            }
            let html = '';
            data.lines.forEach(line => {
              html += `
                    <tr>
                        <td class="text-truncate" style="max-width: 120px;">${line.desc} <small class="text-muted d-block">x${parseFloat(line.qty)}</small></td>
                        <td class="text-end">${parseFloat(line.price).toFixed(2)}</td>
                        <td class="text-end fw-bold">${parseFloat(line.total).toFixed(2)}</td>
                    </tr>
                `;
            });
            document.getElementById('dbItems').innerHTML = html;
          })
          .catch(err => {
            console.error(err);
            document.getElementById('dbItems').innerHTML = '<tr><td colspan="3" class="text-danger text-center">Error al cargar detalle</td></tr>';
          });
      }
    </script>
  </body>
</html>